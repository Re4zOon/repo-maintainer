{% extends "base.html" %}

{% block title %}Dashboard - Repo Maintainer{% endblock %}

{% block content %}
<div class="dashboard">
    <h2>üìä Dashboard</h2>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">üìß</div>
            <div class="stat-content">
                <h3>Total Notifications</h3>
                <p class="stat-value" id="total-notifications">Loading...</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">üåø</div>
            <div class="stat-content">
                <h3>Branch Notifications</h3>
                <p class="stat-value" id="branch-notifications">Loading...</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">üîÄ</div>
            <div class="stat-content">
                <h3>MR Notifications</h3>
                <p class="stat-value" id="mr-notifications">Loading...</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">üí¨</div>
            <div class="stat-content">
                <h3>MR Comments Posted</h3>
                <p class="stat-value" id="mr-comments">Loading...</p>
            </div>
        </div>
    </div>

    <div class="config-summary">
        <h3>‚öôÔ∏è Current Configuration</h3>
        <div class="config-grid">
            <div class="config-item">
                <span class="config-label">Stale Days:</span>
                <span class="config-value" id="stale-days">-</span>
            </div>
            <div class="config-item">
                <span class="config-label">Cleanup Weeks:</span>
                <span class="config-value" id="cleanup-weeks">-</span>
            </div>
            <div class="config-item">
                <span class="config-label">Notification Frequency:</span>
                <span class="config-value" id="notification-frequency">-</span>
            </div>
            <div class="config-item">
                <span class="config-label">Projects Monitored:</span>
                <span class="config-value" id="projects-count">-</span>
            </div>
            <div class="config-item">
                <span class="config-label">Auto Archive:</span>
                <span class="config-value" id="auto-archive">-</span>
            </div>
            <div class="config-item">
                <span class="config-label">MR Comments:</span>
                <span class="config-value" id="mr-comments-enabled">-</span>
            </div>
        </div>
    </div>

    <div class="recent-activity">
        <h3>üìã Recent Notifications</h3>
        <div class="table-container">
            <table id="recent-notifications-table">
                <caption class="sr-only">Recent notification history</caption>
                <thead>
                    <tr>
                        <th>Recipient</th>
                        <th>Type</th>
                        <th>Project ID</th>
                        <th>Item</th>
                        <th>Notified At</th>
                    </tr>
                </thead>
                <tbody id="recent-notifications">
                    <tr>
                        <td colspan="5" class="loading">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="recent-activity">
        <h3>üí¨ Recent MR Comments</h3>
        <div class="table-container">
            <table id="recent-comments-table">
                <caption class="sr-only">Recent MR comments history</caption>
                <thead>
                    <tr>
                        <th>Project ID</th>
                        <th>MR IID</th>
                        <th>Comment #</th>
                        <th>Commented At</th>
                    </tr>
                </thead>
                <tbody id="recent-comments">
                    <tr>
                        <td colspan="4" class="loading">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="actions">
        <button id="refresh-stats" class="btn btn-primary" aria-label="Refresh dashboard statistics">üîÑ Refresh Stats</button>
        <button id="export-stats" class="btn btn-secondary" aria-label="Export dashboard statistics as JSON file">üì• Export as JSON</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Load stats on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadStats();
    });

    document.getElementById('refresh-stats').addEventListener('click', loadStats);
    document.getElementById('export-stats').addEventListener('click', exportStats);

    let currentStats = null;

    function loadStats() {
        fetch('/api/stats')
            .then(response => {
                if (response.status === 401) {
                    // Re-prompt for auth
                    window.location.reload();
                    return;
                }
                return response.json();
            })
            .then(data => {
                if (data == null) {
                    // No data to process (e.g. after 401 reload path)
                    return;
                }
                currentStats = data;
                updateDashboard(data);
            })
            .catch(error => {
                console.error('Error loading stats:', error);
                ['total-notifications', 'branch-notifications', 'mr-notifications', 'mr-comments'].forEach(function(id) {
                    var el = document.getElementById(id);
                    if (el) {
                        el.textContent = 'Error';
                    }
                });
            });
    }

    function updateDashboard(stats) {
        // Update stat cards
        document.getElementById('total-notifications').textContent = stats.notifications.total;
        document.getElementById('branch-notifications').textContent = stats.notifications.branches;
        document.getElementById('mr-notifications').textContent = stats.notifications.merge_requests;
        document.getElementById('mr-comments').textContent = stats.mr_comments.total;

        // Update config summary
        document.getElementById('stale-days').textContent = stats.config.stale_days + ' days';
        document.getElementById('cleanup-weeks').textContent = stats.config.cleanup_weeks + ' weeks';
        document.getElementById('notification-frequency').textContent = stats.config.notification_frequency_days + ' days';
        document.getElementById('projects-count').textContent = stats.config.projects_count;
        document.getElementById('auto-archive').textContent = stats.config.enable_auto_archive ? '‚úÖ Enabled' : '‚ùå Disabled';
        document.getElementById('mr-comments-enabled').textContent = stats.config.enable_mr_comments ? '‚úÖ Enabled' : '‚ùå Disabled';

        // Update recent notifications table
        const notificationsBody = document.getElementById('recent-notifications');
        if (stats.notifications.recent.length === 0) {
            notificationsBody.innerHTML = '<tr><td colspan="5" class="empty">No notifications yet</td></tr>';
        } else {
            notificationsBody.innerHTML = stats.notifications.recent.map(n => `
                <tr>
                    <td>${escapeHtml(n.recipient)}</td>
                    <td><span class="badge badge-${escapeHtml(n.type)}">${escapeHtml(n.type)}</span></td>
                    <td>${n.project_id}</td>
                    <td>${escapeHtml(n.item)}</td>
                    <td>${formatDate(n.notified_at)}</td>
                </tr>
            `).join('');
        }

        // Update recent comments table
        const commentsBody = document.getElementById('recent-comments');
        if (stats.mr_comments.recent.length === 0) {
            commentsBody.innerHTML = '<tr><td colspan="4" class="empty">No comments yet</td></tr>';
        } else {
            commentsBody.innerHTML = stats.mr_comments.recent.map(c => `
                <tr>
                    <td>${c.project_id}</td>
                    <td>!${c.mr_iid}</td>
                    <td>#${c.comment_index + 1}</td>
                    <td>${formatDate(c.commented_at)}</td>
                </tr>
            `).join('');
        }
    }

    function exportStats() {
        if (!currentStats) {
            alert('No stats loaded yet. Please wait for the data to load.');
            return;
        }
        
        const dataStr = JSON.stringify(currentStats, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        
        const exportFileDefaultName = 'repo-maintainer-stats-' + new Date().toISOString().slice(0,10) + '.json';
        
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatDate(dateStr) {
        try {
            const date = new Date(dateStr);
            return date.toLocaleString();
        } catch (e) {
            return dateStr;
        }
    }

    // Auto-refresh (default every 30 seconds, configurable via window.DASHBOARD_AUTO_REFRESH_INTERVAL)
    const AUTO_REFRESH_INTERVAL = window.DASHBOARD_AUTO_REFRESH_INTERVAL || 30000;
    setInterval(loadStats, AUTO_REFRESH_INTERVAL);
</script>
{% endblock %}
